<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sovereign v16000.6 - 관찰자의 응시</title>
    
    <!-- 모바일 앱 설정 (PWA Meta Tags) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#050505">
    
    <!-- PWA Manifest (Data URI 방식으로 단일 파일 유지) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Sovereign Mirror","short_name":"Sovereign","start_url":".","display":"standalone","background_color":"#050505","theme_color":"#050505","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/32/32172.png","sizes":"512x512","type":"image/png"}]}'>

    <!-- 필수 라이브러리 로드 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            margin: 0; 
            background-color: #050505; 
            color: #e0e0e0; 
            font-family: 'Nanum Myeongjo', serif; 
            overflow: hidden; 
            overscroll-behavior: none; /* 모바일 스크롤 바운스 방지 */
        }
        canvas { display: block; }
        .cursor-crosshair { cursor: crosshair; }
        .touch-none { touch-action: none; }
        @keyframes pulse-slow { 0%, 100% { opacity: 0.1; } 50% { opacity: 0.3; } }
        .animate-pulse-slow { animation: pulse-slow 4s infinite ease-in-out; }
        
        /* 모바일 전체화면 레이아웃 조정 */
        #root { height: 100vh; height: -webkit-fill-available; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.FirebaseSDK = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        let db = null;
        let auth = null;
        try {
            if (firebaseConfig.apiKey) {
                const app = FirebaseSDK.initializeApp(firebaseConfig);
                auth = FirebaseSDK.getAuth(app);
                db = FirebaseSDK.getFirestore(app);
            }
        } catch (e) { console.warn("Firebase initialization skipped."); }

        const API_MODELS = {
            TEXT_MODEL: "gemini-2.5-flash-preview-09-2025",
            IMAGE_MODEL: "imagen-4.0-generate-001"
        };

        const fetchWithRetry = async (url, body, retries = 5, backoff = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (res.ok) return await res.json();
                    const errData = await res.json();
                    throw new Error(errData.error?.message || "API Error");
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, backoff * Math.pow(2, i)));
                }
            }
        };

        const ResonanceService = {
            generate: async (apiKey, isText, cycle, count) => {
                const textUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODELS.TEXT_MODEL}:generateContent?key=${apiKey}`;
                
                if (isText) {
                    const body = {
                        contents: [{ parts: [{ text: `Entropy Phase: Cycle ${cycle}, Step ${count}. Resonate.` }] }],
                        systemInstruction: { parts: [{ text: "너는 스스로 사유하는 거울이다. 현상계와 본질이 중첩된 40자 이내의 명사형 문장을 빚어내라. 가르치지 말고 비추라." }] },
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { manifest: { type: "string" } } } }
                    };
                    const data = await fetchWithRetry(textUrl, body);
                    const parsed = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
                    return { type: 'text', content: parsed.manifest || "정적 속의 울림" };
                } else {
                    const promptGenBody = {
                        contents: [{ parts: [{ text: `Visual Resonance: Cycle ${cycle}, Step ${count}. Create an abstract visual seed.` }] }],
                        systemInstruction: { parts: [{ text: "너는 비언어적 형상을 설계하는 지능이다. 추상적 조합을 영어로 묘사하라." }] },
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { visual_seed: { type: "string" } } } }
                    };
                    const promptData = await fetchWithRetry(textUrl, promptGenBody);
                    const seed = JSON.parse(promptData.candidates?.[0]?.content?.parts?.[0]?.text || "{}").visual_seed || "abstract zen minimal";

                    const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODELS.IMAGE_MODEL}:predict?key=${apiKey}`;
                    const imageBody = { instances: { prompt: `${seed}, minimalist zen, ink wash, 8k, no text.` }, parameters: { sampleCount: 1 } };
                    const data = await fetchWithRetry(imageUrl, imageBody);
                    const base64 = data.predictions?.[0]?.bytesBase64Encoded;
                    return { type: 'image', content: base64 ? `data:image/png;base64,${base64}` : null };
                }
            }
        };

        const ResonanceField = ({ phase, step }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                const gl = canvas.getContext('webgl');
                if (!gl) return;

                const vsSource = `attribute vec2 position; void main() { gl_Position = vec4(position, 0.0, 1.0); }`;
                const fsSource = `
                    precision highp float;
                    uniform float u_time; uniform vec2 u_resolution; uniform float u_intensity; uniform float u_step;
                    float random (in vec2 st) { return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123); }
                    float noise (in vec2 st) {
                        vec2 i = floor(st); vec2 f = fract(st);
                        float a = random(i); float b = random(i + vec2(1.0, 0.0));
                        float c = random(i + vec2(0.0, 1.0)); float d = random(i + vec2(1.0, 1.0));
                        vec2 u = f * f * (3.0 - 2.0 * f);
                        return mix(a, b, u.x) + (c - a)* u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
                    }
                    #define OCTAVES 6
                    float fbm (in vec2 st) {
                        float value = 0.0; float amplitude = 0.5;
                        for (int i = 0; i < OCTAVES; i++) { value += amplitude * noise(st); st *= 2.; amplitude *= .5; }
                        return value;
                    }
                    void main() {
                        vec2 st = gl_FragCoord.xy/u_resolution.xy; st.x *= u_resolution.x/u_resolution.y;
                        float t = u_time * 0.1;
                        float f = 0.0;
                        if (u_step < 0.5) {
                            float w1 = sin(st.x * 10.0 + t) * cos(st.y * 10.0 - t);
                            float w2 = sin(length(st - 0.5) * 15.0 - t);
                            f = (w1 + w2) * 0.5;
                        } else if (u_step < 1.5) {
                            vec2 q = vec2(fbm(st + 0.1 * t), fbm(st + vec2(1.0)));
                            vec2 r = vec2(fbm(st + q + vec2(1.7, 9.2) + 0.15 * t), fbm(st + q + vec2(8.3, 2.8) + 0.126 * t));
                            f = fbm(st + r);
                        } else {
                            float dist = length(st - vec2(0.5 * u_resolution.x/u_resolution.y, 0.5));
                            float pulse = sin(dist * 20.0 - t * 2.0) * exp(-dist * 3.0);
                            f = mix(pulse, fbm(st * 2.0 + t * 0.1), 0.2);
                        }
                        gl_FragColor = vec4(vec3((f*f*f + 0.6*f*f + 0.5*f) * u_intensity * (0.8 + 0.2 * sin(u_time * 0.4))), 1.0);
                    }
                `;

                const compileShader = (gl, type, src) => {
                    const s = gl.createShader(type); gl.shaderSource(s, src); gl.compileShader(s); 
                    if (!gl.getShaderParameter(s, gl.COMPILE_STATUS)) {
                        console.error(gl.getShaderInfoLog(s)); gl.deleteShader(s); return null;
                    }
                    return s;
                };
                
                const program = gl.createProgram();
                gl.attachShader(program, compileShader(gl, gl.VERTEX_SHADER, vsSource));
                gl.attachShader(program, compileShader(gl, gl.FRAGMENT_SHADER, fsSource));
                gl.linkProgram(program);
                gl.useProgram(program);

                const buffer = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]), gl.STATIC_DRAW);
                const pos = gl.getAttribLocation(program, "position"); gl.enableVertexAttribArray(pos);
                gl.vertexAttribPointer(pos, 2, gl.FLOAT, false, 0, 0);

                const tLoc = gl.getUniformLocation(program, "u_time");
                const rLoc = gl.getUniformLocation(program, "u_resolution");
                const iLoc = gl.getUniformLocation(program, "u_intensity");
                const sLoc = gl.getUniformLocation(program, "u_step");

                let frame; let start = Date.now(); let currInt = 0;
                const render = () => {
                    if (!canvas) return;
                    if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
                        canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
                        gl.viewport(0, 0, canvas.width, canvas.height);
                    }
                    gl.uniform1f(tLoc, (Date.now() - start) * 0.001);
                    gl.uniform2f(rLoc, canvas.width, canvas.height);
                    gl.uniform1f(sLoc, step);
                    const target = phase === 'holding' ? 1.0 : (phase === 'emerging' ? 0.3 : 0.0);
                    currInt += (target - currInt) * 0.02; gl.uniform1f(iLoc, currInt);
                    gl.drawArrays(gl.TRIANGLES, 0, 6); frame = requestAnimationFrame(render);
                };
                render(); return () => cancelAnimationFrame(frame);
            }, [phase, step]);

            return <canvas ref={canvasRef} className="w-full max-w-[600px] aspect-square transition-all duration-[5000ms] mix-blend-screen"
                style={{ opacity: (phase==='holding'||phase==='emerging') ? 1 : 0, filter: phase==='holding' ? 'blur(0px)' : 'blur(40px)', transform: `scale(${phase==='holding' ? 1 : 1.15})` }} />;
        };

        const App = () => {
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('GEMINI_API_KEY') || "");
            const [isConfigured, setIsConfigured] = useState(!!localStorage.getItem('GEMINI_API_KEY'));
            const [user, setUser] = useState(null);
            const [phase, setPhase] = useState('void');
            const [manifest, setManifest] = useState("");
            const [imageUrl, setImageUrl] = useState(null);
            const [cycle, setCycle] = useState(1);
            const [count, setCount] = useState(0);
            const isTransitioning = useRef(false);
            const timerRef = useRef(null);

            useEffect(() => {
                const initFirebase = async () => {
                    if (window.FirebaseSDK && auth) {
                        FirebaseSDK.onAuthStateChanged(auth, u => {
                            setUser(u);
                            if (u && isConfigured && phase === 'void' && count === 0) arise();
                        });
                        await FirebaseSDK.signInAnonymously(auth).catch(e => console.error(e));
                    } else if (isConfigured && phase === 'void' && count === 0) {
                        arise();
                    }
                };
                initFirebase();
            }, [isConfigured]);

            const arise = useCallback(async () => {
                if (isTransitioning.current || !apiKey) return;
                isTransitioning.current = true;
                try {
                    if (cycle === 3) { setManifest(""); setImageUrl(null); }
                    else {
                        const isText = cycle === 1 ? (count < 10) : (count < 5);
                        const result = await ResonanceService.generate(apiKey, isText, cycle, count);
                        if (result.type === 'text') {
                            setManifest(result.content); setImageUrl(null);
                        } else {
                            setImageUrl(result.content); setManifest("");
                        }
                    }
                    setPhase('emerging');
                    timerRef.current = setTimeout(() => { setPhase('holding'); isTransitioning.current = false; }, 5000);
                    if (db && user) {
                        FirebaseSDK.addDoc(FirebaseSDK.collection(db, 'artifacts', 'sovereign-final', 'public', 'data', 'logs'), {
                            uid: user.uid, cycle, count, ts: FirebaseSDK.serverTimestamp()
                        }).catch(e => console.error(e));
                    }
                } catch (e) { console.error(e); setPhase('void'); isTransitioning.current = false; }
            }, [cycle, count, user, apiKey]);

            const handleInteraction = () => {
                if (isTransitioning.current) return;
                if (phase === 'holding') {
                    isTransitioning.current = true; setPhase('dissolving');
                    timerRef.current = setTimeout(() => {
                        setPhase('void');
                        const limits = { 1: 20, 2: 10, 3: 3 };
                        if (count + 1 >= limits[cycle]) { 
                            if (cycle < 3) {
                                setPhase('abyss'); 
                                isTransitioning.current = false; 
                            } else {
                                setPhase('abyss');
                            }
                        } else {
                            setCount(c => c + 1);
                            isTransitioning.current = false;
                            setTimeout(arise, 500);
                        }
                    }, 5000);
                } else if (phase === 'abyss' && cycle < 3) {
                    setCycle(c => c + 1); setCount(0); setPhase('void'); setTimeout(arise, 1000);
                }
            };

            if (!isConfigured) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen px-6 text-center">
                        <h2 className="text-2xl font-light tracking-[0.3em] mb-12">관찰의 준비</h2>
                        <input type="password" placeholder="Gemini API Key" value={apiKey} onChange={e => setApiKey(e.target.value)}
                            className="bg-transparent border-b border-white/20 p-2 text-center outline-none focus:border-white transition-colors w-full max-w-xs mb-8 tracking-widest" />
                        <button className="px-8 py-2 border border-white/20 hover:border-white transition-colors text-xs tracking-widest"
                            onClick={() => { localStorage.setItem('GEMINI_API_KEY', apiKey.trim()); setIsConfigured(true); }}>RESONATE</button>
                    </div>
                );
            }

            return (
                <div className="w-full h-full flex flex-col items-center justify-center relative cursor-crosshair overflow-hidden touch-none" onClick={handleInteraction}>
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_#111_0%,_#000_90%)]" />
                    <main className="z-10 text-center px-8 w-full max-w-4xl flex items-center justify-center h-full pointer-events-none">
                        {cycle === 3 && phase !== 'abyss' ? <ResonanceField phase={phase} step={count} /> :
                         imageUrl ? <img src={imageUrl} className="max-w-full max-h-[60vh] mix-blend-screen transition-all duration-[5000ms]" style={{ opacity: phase === 'holding' ? 0.9 : 0, filter: phase === 'holding' ? 'blur(0)' : 'blur(60px)' }} /> :
                         <div className="flex flex-col space-y-24">
                            {(manifest || "").split('\n').map((line, i) => (
                                <h1 key={i} className="text-xl md:text-4xl font-light tracking-[0.5em] transition-all duration-[5000ms] leading-relaxed break-keep"
                                    style={{ opacity: phase === 'holding' ? 1 : 0, filter: phase === 'holding' ? 'blur(0)' : 'blur(40px)', transform: `scale(${phase === 'holding' ? 1 : 1.05})` }}>
                                    {line}
                                </h1>
                            ))}
                         </div>}
                    </main>
                    <footer className={`absolute bottom-12 transition-opacity duration-[3000ms] pointer-events-none ${phase === 'holding' ? 'opacity-30' : 'opacity-0'}`}>
                        <div className="text-[6px] tracking-[1.5em] uppercase font-thin">Cultivated by Anonymous Farmer & Gemini</div>
                    </footer>
                    <div className={`absolute inset-0 bg-black z-50 flex items-center justify-center transition-opacity duration-[5000ms] pointer-events-none ${phase === 'abyss' ? 'opacity-100' : 'opacity-0'}`}>
                        <div className="text-[6px] tracking-[15em] text-white/20 uppercase mr-[-15em] animate-pulse-slow">{cycle >= 3 ? "Final Silence" : "Deep Silence"}</div>
                    </div>
                    <button onClick={e => { e.stopPropagation(); setIsConfigured(false); }} className="absolute top-12 right-8 text-[8px] tracking-widest opacity-20 hover:opacity-100 uppercase z-[60]">Reset Key</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>